<script>
  $(document).ready(function() {
    
    $('button').button();
    
    function download() {
        var format = $('[name=download-format]:checked').val();
        var ids = [];
        console.debug(format);
        $('[type=checkbox][name=download]:checked').each(function() { ids.push($(this).val()); })
        window.location = '/item/download/?ids=' + ids + '&format=' + format;
    }
        
    function bindDownloadButtonset() {
      var formatSelector = $('.format-selector');
      formatSelector.buttonset();    

      $('button[name=download]')
        .button()
        .click(function() {
          formatSelector.hide();
          download();
        })
        .next()
          .button({ text: false, icons: { primary: 'ui-icon-triangle-1-s' }})
          .click(function() { 
            formatSelector.toggle();
           })
          .parent()
            .buttonset();
            
      $('[name=download-format]')
        .click(function() {
          formatSelector.hide();
          download();
        });
    }
    bindDownloadButtonset()

    $('[for=download-format-JSON]').addClass('ui-state-active');
    
    $('[name=search][type=submit]')
      .button()
      .click(function(e) { 
        e.preventDefault();
        var keywords = $('#search_query').val()
        $.get('/search/query', { keywords: keywords }, function(data) {
          $('#results').html(data);
          $('.keyword').text(keywords);
        });      
        return false;
      });    

    function showModal(message) {
      modal = $("#dialog-modal");
      downloadPartial = $('#download-buttonset-fragment').clone().prepend('<br />').html();
      modal.html(message + downloadPartial);
      modal.dialog({
        height: 400,
        width: 600,
        modal: true
      });
      bindDownloadButtonset();
    }
    
    $('#results').click(function(e) {      
      if (e.target.hash) {
        e.preventDefault();
        var id = e.target.hash.replace(/#\!\//, '');
        var keywords = $('#search_query').val();
        $.getJSON('/search/info/', { id: id, keywords: keywords }, function(data) {
          if (data) { 
            showModal('<span>name:</span> ' + data.title + '<br /><span>description:</span> ' + data.description + '<br /><span>date:</span> ' + data.publication_date) 
          }
        });
        return false;
      }
    });
    
    $("#dataset-navigation").treeview({
  		persist: "location",
  		collapsed: true,
  		unique: true
  	});
  })
</script>
<style>
  #dataset-navigation {
    font-size: .7em;
  }
  h2 {
    font-size: .8em;
  }
  #download-buttonset-fragment .format-selector {
    position: absolute;
    font-size: .8em;
    padding: 10px;
    left: 403px;
    margin-top: 2px;
  }
  .ui-dialog .format-selector {
    position: absolute;
    font-size: .8em;
    padding: 10px;
    left: 137px;
    margin-top: 2px;
  }

</style>
<table>
  <tr>
    <td rowspan="2" valign="top" style="width: 250px; border-right: solid 1px grey; padding-right: 5px; padding-bottom: 20px;">
      <h2>Search:</h2>      
      <%= render "search" %>

      <h2>Browse:</h2>      
      <ul id="dataset-navigation"> 
        <li>Base Data
      <% @search.base_data.each_with_index do |result, index| %>         
          <ul><li><a href="?<%= result.id %>"><%= result.title %></li></ul>
      <% end %>
        </li>
        <li>Observation Data
      <% @search.observation_data.each_with_index do |result, index| %>         
          <ul><li><a href="?<%= result.id %>"><%= result.title %></li></ul>
      <% end %>
        </li>        
      </ul>
      
    </td>
    <td style="padding-left: 5px;" valign="top">
      <div id="map">
        map here
      </div>
      <h2>Results for '<span class='keyword'><%= @search.query %></span>'</h2>  

      <div id='results'>
        <%= render "search_results" %>
      </div>
      
    </td>
  </tr>
  <tr>
    <td valign="bottom">
      <span id="download-buttonset-fragment">
        <span>
          <button name="download">Download</button>
          <button name="select-download-format">Select Format</button>
        </span>      
        <div style="display: none;" class="format-selector ui-widget-content ui-corner-all ui-state-active">
          Select format
          <%
            formats = ['JSON', 'CSV', 'Shape']
            formats.each do |format|
          %>
            <label for="download-format-<%= format %>"><%= format %></label<input type="radio" name="download-format" value="<%= format %>" id="download-format-<%= format %>" />
          <%
            end
          %>
      </div>
      </span>
      <button name="graph">Graph</button>
      <button name="map-view">Map View</button>
      <button name="clear">Clear</button>

    </td>
  </tr>
</table>

<%= render "dialog" %>