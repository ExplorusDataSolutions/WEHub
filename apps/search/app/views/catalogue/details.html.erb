<% content_for :title, @dataset.name %>

<script>
  <% #ToDo fix the layout so the height of these two boxes don\'t need to be sync'd through JavaScript%>
  $(document).ready(function() {
    $('.sub-content-right').height($('.right-container-left-body').height() - 10);
  });
</script>
<script>
  $(document).ready(function() {
    setTimeout(function() {
      $.ajax({
        url: '<%= url_for :controller => "user", :action => "modify_recently_viewed" %>',
        data: { id: '<%= @dataset.uuid %>' },
        type: 'POST',
        global: false
      });
    }, 5000);

    if (WEHub.logged_in()) {
      $('#my-collection').show();
      $('#my-collection').click(function() {
        var ids = [];
        ids.push('<%= @dataset.uuid %>');
        $.post("<%= url_for :controller => 'user', :action => 'modify_collection' %>", { ids: ids }, function(data) { location.reload(); });
      });
      
      $.ajax({
        url: "<%= url_for :controller => 'user', :action => 'reviews'%>?id=" + WEHub.id(),
        cache: false,
        dataType: 'json',
        global: false,
        success: function(data) {
          if (data) {
            for (var i=0 ; i < data.length ; i++) {
              if (data[i] === '<%= @dataset.uuid %>') {
               return;
              }
            }
          }  
          $('#add-review').show();
          $('#add-review').click(function() {
            WEHub.dialog("Review this dataset", $('.new-comment:first').html());
            $('#dialog-modal .rating-container').rating();
            $("#dialog-modal").dialog('option', 'buttons', [{
              text: "Submit",
              click: function() { 
                $.post("<%= url_for :controller => 'reviews', :action => 'create', :id => @dataset.id %>", $(this).find('form').serialize(), function(data) { location.reload(); });
                $(this).dialog("close");              
              }
            }]);
          });
        }
      });
    }
  });
</script>
<style>
.format-selector {
  font-size: 0.8em;
  margin-left: -110px;
  padding: 1px 8px;
  position: absolute;
  z-index: 100;
}
#layer-selector table {
  border-collapse: collapse; 
  margin: 0;
}
#layer-selector {
  padding-bottom: 5px;
}
#date-range {
  padding-bottom: 10px;
  padding-top: 10px;  
}
#date-range input {
  width: 98px;
}
#bbox-selector input {
  width: 70px;
}
</style>
<script>
  $(document).ready(function() {

    $('button').button();

    function download() {
      var uri = "<%= url_for :controller => 'item', :action => 'download' %>";
      $.getJSON(uri + '?' + $('form[name=download]').serialize() , function(data) {
        if (data.success) {
          window.location = uri + '?filename=' + data.filename; 
        } else {
          var is_external = false;
          var is_no_data = false;
          $.each(data.errors, function(i, v) { 
            if (v.match(/external_service:/)) {
              is_external = true;
            }
            if (v.match(/no data found/i) || v.match(/no stations found/i)) {
              is_no_data = true;
            }
          });
          
          if (is_external) {
            if (is_no_data) {
              WEHub.modal("We're Sorry", "No data could be retrieved for your selected time period and bounding box. Try making a new request.");
            } else {
              WEHub.modal("We're Sorry", "We're having trouble retrieving this feature's data from an external service. Please try again at a later date.");
            }
          } else {
            WEHub.modal("We're Sorry", "We're having trouble generating the " + $('[name=format]:checked').val() + " format for this feature. Please try an alternate format.");
          }
        }
      });
    }
      
    var formatSelector = $('.format-selector');  
    function bindDownloadButtonset() {
      $('.format-buttons').buttonset();    

      $('button[name=download]')
        .button()
        .click(function() {
          formatSelector.hide();
          download();
        })
        .next()
          .button({ text: false, icons: { primary: 'ui-icon-triangle-1-s' }})
          .click(function() { 
            formatSelector.toggle();
           })
          .parent()
            .buttonset();
            
      $('form[name=download] [name=format]')
        .click(function() {
          formatSelector.hide();
          download();
        });
    }
    bindDownloadButtonset()
    
    $('.tab-download').click(function() {
      formatSelector.show();
    });
    
    $('form[name=download]').find('[name=start],[name=end]').datepicker({ dateFormat: 'dd/mm/yy' });
  }); 
</script>
<script>
$(document).ready(function() {
  
  var map, layer, lon, lat;
<%
  if @dataset.coordinates && !@dataset.coordinates.empty?
    coords = @dataset.coordinates.split(',') 
    if coords.length == 2
%>
   <%= "lat = #{coords[0]};" %>
   <%= "lon = #{coords[1]};" %>
<%
    end 
  end  
%>

  function loadMap() {
    var options = {
      displayProjection: new OpenLayers.Projection("EPSG:4326"),
      units: "m",
      numZoomLevels: 22,
      maxExtent: new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508.34)
    };  
    map = new OpenLayers.Map('map', options);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    
    var gphy = new OpenLayers.Layer.Google("Google Physical", {type: G_PHYSICAL_MAP, sphericalMercator: true, numZoomLevels: 22});
    var gmap = new OpenLayers.Layer.Google("Google Streets", {numZoomLevels: 22});
    var ghyb = new OpenLayers.Layer.Google("Google Hybrid", {type: G_HYBRID_MAP, numZoomLevels: 22});
    var gsat = new OpenLayers.Layer.Google("Google Satellite", {type: G_SATELLITE_MAP, numZoomLevels: 22});

    map.addLayers([gphy, gmap, ghyb, gsat]);
    
    WEHub.OpenLayers.setCenter(map, lon, lat, 1);

    markers = new OpenLayers.Layer.Markers("Features");
    map.addLayer(markers);

  }
  
  function setMarker(lon, lat){
    var lonLatMarker = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

    var feature = new OpenLayers.Feature(markers, lonLatMarker);

    var size = new OpenLayers.Size(20, 34);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    var icon = new OpenLayers.Icon('/images/marker-blue.png', size, offset);   
    var marker = new OpenLayers.Marker(lonLatMarker, icon.clone());

    markers.addMarker(marker);
  }
        
  function setLayer(name, uuid){
    var datasetLayer = new OpenLayers.Layer.WMS(name, <%= "'#{Rails.application.config.geoserver_address}/geoserver/wms?service=WMS&version=1.1.0&request=GetMap&layers=gn:'".html_safe %> + uuid,
      { transparent: true,
        layers: name,
        format: 'image/png',
        srs: 'EPSG:4326'
      },
      { reproject: false }
    );
    map.addLayer(datasetLayer);
  }
  
  loadMap();
  if (<%= @dataset.wms %>) {
    setLayer(<%= "'#{@dataset.name}'" %>, <%= "'#{@dataset.uuid}'" %>)
  } else if (<%= !@dataset.bounding_box.nil? && !@dataset.bounding_box.empty? %>) { 
  } else {
    setMarker(lon, lat);    
  }
  
<% if @dataset.bounding_box %>

      var boxControl = new OpenLayers.Control();
      OpenLayers.Util.extend(boxControl, {
        draw: function () {
          this.box = new OpenLayers.Handler.Box(boxControl, { "done": function(bounds) { 
            var leftBottom = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom)).transform(map.getProjectionObject(),  new OpenLayers.Projection('EPSG:4326'));
            var rightTop = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top)).transform(map.getProjectionObject(),  new OpenLayers.Projection('EPSG:4326'));
            setBoundingBox(rightTop.lat, rightTop.lon, leftBottom.lat, leftBottom.lon);
          }});
        }
      });
      
      function setBoundingBox(north, east, south, west) {
        $('[name=north]').val(north);
        $('[name=east]').val(east);
        $('[name=south]').val(south);
        $('[name=west]').val(west);
      }   

      map.addControl(boxControl);
      
      $('#box_selector').click(function(event) {
        event.preventDefault();
        $('#box_display').slideToggle();
        if (boxControl.box.active) {
          boxControl.box.deactivate();
        } else {
          boxControl.box.activate();
          $('html, body').animate({scrollTop: $("#map").offset().top }, 500);
          $('#map').effect("pulsate", { times:1 }, 2000);
        }
      });

  <% if @dataset.layers %>
    <% @dataset.layers.each_with_index do |layer, i| %>

  <%=
  "var bounds#{i} = new OpenLayers.Bounds();
  bounds#{i}.extend(new OpenLayers.LonLat(#{layer.bounding_box[:east]},#{layer.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds#{i}.extend(new OpenLayers.LonLat(#{layer.bounding_box[:west]},#{layer.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  var boxes = new OpenLayers.Layer.Boxes('boxes');
  var box = new OpenLayers.Marker.Box(bounds#{i});
  box.setBorder('#{box_colours(i)}', 2);  
  boxes.addMarker(box);
  map.addLayer(boxes);
  
  var bounds = new OpenLayers.Bounds();
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:east]},#{@dataset.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:west]},#{@dataset.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  map.zoomToExtent(bounds);
  
  ".html_safe    
  -%>
    <% end %>
  <% else %>
  <%=
  "var bounds = new OpenLayers.Bounds();
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:east]},#{@dataset.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:west]},#{@dataset.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  var boxes = new OpenLayers.Layer.Boxes('boxes');
  var box = new OpenLayers.Marker.Box(bounds);
  boxes.addMarker(box);
  map.addLayer(boxes);
  map.zoomToExtent(bounds);
  map.zoomTo(map.zoom - 1);

  ".html_safe
  %>  
  <% end %>

<% end %>
});
</script>
<div class="top-back-link">
    <a href="#" onclick="history.go(-1);return false;">Back to Search Results</a>
</div>
<div class="top-container-tab-body" >
  <div class="top-container-tab" id="add-review" style="display: none;">+ Comments</div>
  <div class="top-container-tab" id="my-collection" style="display: none;">+ My collection</div>
  <div class="top-container-tab tab-download">
    <div class="float-left">Download</div>
    <div class="float-left tab-download-arrow"></div>   
  </div>
  <div class="clear"></div>
  
  <div class="format-selector ui-widget-content ui-corner-all ui-state-active" style="display: none;">
  <%= form_for :download, :method => :get, :url => { :controller => 'item', :action => 'download' }, :html => { :name => 'download' } do %>
    <%= hidden_field_tag :ids, params[:id] %>
    <% if @dataset.external %>
      <div id="date-range"><%= label_tag :start, "Select a date range" %> <%= text_field_tag :start %> - <%= text_field_tag :end %></div>
      <% if @dataset.layers %>
      <div id="layer-selector">
        <table>
          <tr>
            <td valign="top" rowspan="<%= @dataset.layers.count + 1 %>">Select a feature layer</td>
          </tr>        
          <% @dataset.layers.each_with_index do |layer, i| %>
          <tr><td><%= radio_button_tag :layer, layer.layer_id %></td><td><%= label_tag "layer[#{layer.layer_id}]", "#{layer.name} (<span style='color: #{box_colours(i)}'>#{box_colours(i)}</span>)".html_safe %></td></tr>
          <% end %>
        </table>
      </div>
      <% end %>
      <div id="bbox-selector">Select a bounding box <a href="#" id="box_selector">(click here to use the map)</a>
        <table>
          <tr><td></td><td><%= text_field_tag :north %></td><td></td></tr>
          <tr><td style="padding-left: 97px"><%= text_field_tag :west %></td><td></td><td><%= text_field_tag :east %></td></tr>
          <tr><td></td><td><%= text_field_tag :south %></td><td></td></tr>
        </table>
      </div>
    <% end %>
    Select format
    <span class="format-buttons">
    <% @dataset.formats.format.each do |format| %>
      <%= label_tag "format[#{format}]", format %><%= radio_button_tag :format, format %>
    <% end %>
    </span>
  <% end %>
  </div>

</div>
<div class="clear"></div>
  
<div class="clear"></div>

<div class="left-container-tab-body">
<%
=begin %>
  <div class="tab"><%= link_to 'Map', :controller => 'tools', :action => 'map', :id => @dataset.uuid %></div>
  <div class="tab"><%= link_to 'Graph', :controller => 'tools', :action => 'chart', :id => @dataset.uuid %></div>
<% 
=end %>
  <div class="tab"><%= link_to 'Connect', :controller => 'community' %></div>
</div>
<div class="right-container-body">
  <div class="right-container-left-body">
    <div class="dashed-header"><h2><%= @dataset.name %></h2></div>
    <div class="clear"></div>
    <div class="slight-margin">
      <h2 class="green-dot-blue-head">Metadata</h2>
      
      <div class="float-left width-165 title">Title</div>
      <div class="float-left width-500 text"><%= @dataset.name %></div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Date</div>
      <div class="float-left width-500 text"><%= @dataset.date %></div>
      <div class="clear"></div>

    <% if @dataset.period %>
      <div class="float-left width-165 title">Extent</div>
      <div class="float-left width-500 text"><%= @dataset.period %></div>
      <div class="clear"></div>
    <% end %>
      
      <div class="float-left width-165 title">Abstract</div>
      <div class="float-left width-500 text">
        <%= @dataset.description %>
        <% if !@dataset.source.nil? %>
        <br />
        <% 
          url = ''
          if @dataset.source
            if @dataset.source.match(/http:\/\//)
              url = @dataset.source
            else
              url = "http://#{@dataset.source}"
            end
          end
        %>
        (source: <%= link_to url, url %>)
        <% end %>
      </div>
      <div class="clear"></div>
      <div class="clear height-25"></div>

    
      <div class="float-left">
    <% if @dataset.bounding_box && !@dataset.bounding_box.empty? %>
        <% bbox = @dataset.bounding_box %>
        <h2 class="green-dot-blue-head">Geographic bounding box</h2>
        <div class="float-left width-165 title">East Bound Longitude</div>
        <div class="float-left width-140 text"><%= bbox[:east] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">West Bound Longitude</div>
        <div class="float-left width-140 text"><%= bbox[:west] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">North Bound Latitude</div>
        <div class="float-left width-140 text"><%= bbox[:north] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">South Bound Latitude</div>
        <div class="float-left width-140 text"><%= bbox[:south] %></div>
        <div class="clear height-25"></div>
    <% elsif @dataset.coordinates && !@dataset.coordinates.empty? %>
        <h2 class="green-dot-blue-head">Geographic coordinates</h2>
        <div class="float-left width-165 title">Latitude</div>
        <div class="float-left width-140 text"><%= @dataset.coordinates.split(',')[0] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">Longitude</div>
        <div class="float-left width-140 text"><%= @dataset.coordinates.split(',')[1] %></div>
        <div class="clear height-25"></div>
    <% else %>
        <h2 class="green-dot-blue-head">Geographic bounding box</h2>
        <div class="float-left width-165 title">East Bound Longitude</div>
        <div class="float-left width-140 text">7.21097</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">West Bound Longitude</div>
        <div class="float-left width-140 text">3.37087</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">North Bound Latitude</div>
        <div class="float-left width-140 text">53.46583</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">South Bound Latitude</div>
        <div class="float-left width-140 text">50.75388</div>
        <div class="clear height-25"></div>
    <% end %>
      </div>
      <div class="float-left slight-margin">
        <div id="map" style="width:400px; height:200px"></div>        
      </div>
      <div class="clear"></div>
    <% if @dataset.layers %>
      <h2 class="green-dot-blue-head">Feature Layers</h2>
      <% @dataset.layers.each_with_index do |layer, i| %>
      <div class="float-left width-165 title">Layer <%= i+1 %> (<span style="color: <%= box_colours(i) %>"><%= box_colours(i) %></span>)</div>
      <div class="float-left width-500 text"><%= layer.name %>, <%= layer.period %></div>
      <div class="clear"></div>
      <% end %>
    <% end  %>
      
    <% if !@dataset.author.nil? %>
      <h2 class="green-dot-blue-head">Point of contact</h2>
      
      <div class="float-left width-165 title">Individual name</div>
      <div class="float-left width-500 text"><%= @dataset.author.first_name %><%= @dataset.author.last_name %></div>
      <div class="clear"></div>

<%
=begin %>     
      <div class="float-left width-165 title">Organisation name</div>
      <div class="float-left width-500 text">Deltares/TNO Geological Survey of the Canada</div>
      <div class="clear"></div>
<%
=end %>     
      <div class="float-left width-165 title">Email</div>
      <div class="float-left width-500 text"><%= @dataset.author.email %></div>
      <div class="clear"></div>
<%
=begin %>     
      <div class="float-left width-165 title">Role</div>
      <div class="float-left width-500 text">PointOfContact</div>
      <div class="clear"></div>
<%
=end %>
    <% end %>     
      <div class="float-left width-165 title">Descriptive keywords</div>
      <div class="float-left width-500 text"><%= @dataset.properties %></div>
      <div class="clear"></div>
      
      <div class="clear height-25"></div>
      
<%
=begin %>
      
      <h2 class="green-dot-blue-head">Distribution information</h2>
      
      <div class="float-left width-165 title">Intractive Map</div>
      <div class="float-left width-500 text">http://www.dinoservice.nl/wms/dinomap/MO8MOO21?format=image/png</div>
      <div class="clear"></div>
      
      <div class="clear height-25"></div>
<%
=end %>     
      
      <h2 class="green-dot-blue-head">Identification Information</h2>
      
      <div class="float-left width-165 title">File identifier</div>
      <div class="float-left width-500 text"><%= @dataset.uuid %></div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Language</div>
      <div class="float-left width-500 text">English</div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Character set</div>
      <div class="float-left width-500 text">UTF-8</div>
      <div class="clear"></div>
<%
=begin %>     
      <div class="float-left width-165 title">Date stamp</div>
      <div class="float-left width-500 text">2009-06-26T10:07:03</div>
      <div class="clear"></div>
<% 
=end %>     
      <div class="float-left width-165 title">Metadata standard name</div>
      <div class="float-left width-500 text">ISO 19115:2003/19139</div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Metadata standard version</div>
      <div class="float-left width-500 text">1.0</div>
      <div class="clear"></div>
      
<% if !@dataset.creative_commons_license.nil? %>
      <h2 class="green-dot-blue-head">License</h2>
      <div class="float-left width-165 title">&nbsp;</div>
      <div class="float-left width-500 text"><%= "<a href='http://creativecommons.org/licenses/#{@dataset.creative_commons_license}/3.0/'><img src='/images/#{@dataset.creative_commons_license}.png' alt='creative commons' /></a>".html_safe -%></div>
      <div class="clear"></div>
<% end %>      
      
      <div class="clear height-25"></div>      
    </div>
  </div>
  <div class="sub-content-right">
    <%= render 'shared/right_panel' %>
  </div>    

  <div class="clear"></div>
  
  <%= render 'reviews' %>
    
</div>
