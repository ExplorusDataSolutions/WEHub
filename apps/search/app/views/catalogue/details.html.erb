<% content_for :title, @dataset.name %>

<script>
  <% #ToDo fix the layout so the height of these two boxes don\'t need to be sync'd through JavaScript%>
  $(document).ready(function() {
    $('.sub-content-right').height($('.right-container-left-body').height() - 10);
  });
</script>
<script>
  $(document).ready(function() {
    setTimeout(function() {
      $.ajax({
        url: '<%= url_for :controller => "user", :action => "modify_recently_viewed" %>',
        data: { id: '<%= @dataset.uuid %>' },
        type: 'POST',
        global: false
      });
    }, 5000);

    if (WEHub.logged_in()) {
      $('#my-collection').show();
      $('#my-collection').click(function() {
        var ids = [];
        ids.push('<%= @dataset.uuid %>');
        $.post("<%= url_for :controller => 'user', :action => 'modify_collection' %>", { ids: ids }, function(data) { location.reload(); });
      });
      
      $.ajax({
        url: "<%= url_for :controller => 'user', :action => 'reviews'%>?id=" + WEHub.id(),
        cache: false,
        dataType: 'json',
        global: false,
        success: function(data) {
          if (data) {
            for (var i=0 ; i < data.length ; i++) {
              if (data[i] === '<%= @dataset.uuid %>') {
               return;
              }
            }
          }  
          $('#add-review').show();
          $('#add-review').click(function() {
            WEHub.dialog("Review this dataset", $('.new-comment:first').html());
            $('#dialog-modal .rating-container').rating();
            $("#dialog-modal").dialog('option', 'buttons', [{
              text: "Submit",
              click: function() { 
                $.post("<%= url_for :controller => 'reviews', :action => 'create', :id => @dataset.id %>", $(this).find('form').serialize(), function(data) { location.reload(); });
                $(this).dialog("close");              
              }
            }]);
          });
        }
      });
    }
  });
</script>
<script>
$(document).ready(function() {
  
  var map, layer, lon, lat;
<%
  if @dataset.coordinates && !@dataset.coordinates.empty?
    coords = @dataset.coordinates.split(',') 
    if coords.length == 2
%>
   <%= "lat = #{coords[0]};" %>
   <%= "lon = #{coords[1]};" %>
<%
    end 
  end  
%>

  function loadMap() {
    var options = {
      displayProjection: new OpenLayers.Projection("EPSG:4326"),
      units: "m",
      numZoomLevels: 22,
      maxExtent: new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508.34)
    };  
    map = new OpenLayers.Map('map', options);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    
    var gphy = new OpenLayers.Layer.Google("Google Physical", {type: G_PHYSICAL_MAP, sphericalMercator: true, numZoomLevels: 22});
    var gmap = new OpenLayers.Layer.Google("Google Streets", {numZoomLevels: 22});
    var ghyb = new OpenLayers.Layer.Google("Google Hybrid", {type: G_HYBRID_MAP, numZoomLevels: 22});
    var gsat = new OpenLayers.Layer.Google("Google Satellite", {type: G_SATELLITE_MAP, numZoomLevels: 22});

    map.addLayers([gphy, gmap, ghyb, gsat]);
    
    WEHub.OpenLayers.setCenter(map, lon, lat, 1);

    markers = new OpenLayers.Layer.Markers("Features");
    map.addLayer(markers);

  }
  
  function setMarker(lon, lat){
    var lonLatMarker = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

    var feature = new OpenLayers.Feature(markers, lonLatMarker);

    var size = new OpenLayers.Size(20, 34);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    var icon = new OpenLayers.Icon('/images/marker-blue.png', size, offset);   
    var marker = new OpenLayers.Marker(lonLatMarker, icon.clone());

    markers.addMarker(marker);
  }
        
  function setLayer(name, uuid){
    var datasetLayer = new OpenLayers.Layer.WMS(name, <%= "'#{Rails.application.config.geoserver_address}/geoserver/wms?service=WMS&version=1.1.0&request=GetMap&layers=gn:'".html_safe %> + uuid,
      { transparent: true,
        layers: name,
        format: 'image/png',
        srs: 'EPSG:4326'
      },
      { reproject: false }
    );
    map.addLayer(datasetLayer);
  }
  
  loadMap();
  if (<%= @dataset.wms %>) {
    setLayer(<%= "'#{@dataset.name}'" %>, <%= "'#{@dataset.uuid}'" %>)
  } else if (<%= !@dataset.bounding_box.nil? && !@dataset.bounding_box.empty? %>) { 
  } else {
    setMarker(lon, lat);    
  }
  
<% if @dataset.bounding_box %>

      var boxControl = new OpenLayers.Control();
      OpenLayers.Util.extend(boxControl, {
        draw: function () {
          this.box = new OpenLayers.Handler.Box(boxControl, { "done": function(bounds) { 
            var leftBottom = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom)).transform(map.getProjectionObject(),  new OpenLayers.Projection('EPSG:4326'));
            var rightTop = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top)).transform(map.getProjectionObject(),  new OpenLayers.Projection('EPSG:4326'));
            setBoundingBox(rightTop.lat, rightTop.lon, leftBottom.lat, leftBottom.lon);
          }});
        }
      });
      
      function setBoundingBox(north, east, south, west) {
        $('[name=north]').val(north);
        $('[name=east]').val(east);
        $('[name=south]').val(south);
        $('[name=west]').val(west);
      }   

      map.addControl(boxControl);
      
      $('#box_selector').click(function(event) {
        event.preventDefault();
        $('#box_display').slideToggle();
        if (boxControl.box.active) {
          boxControl.box.deactivate();
        } else {
          boxControl.box.activate();
          $('html, body').animate({scrollTop: $("#map").offset().top }, 500);
          $('#map').effect("pulsate", { times:1 }, 2000);
        }
      });

  <% if @dataset.layers %>
    <% @dataset.layers.each_with_index do |layer, i| %>
      <% if layer.bounding_box %>
  <%=
  "var bounds#{i} = new OpenLayers.Bounds();
  bounds#{i}.extend(new OpenLayers.LonLat(#{layer.bounding_box[:east]},#{layer.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds#{i}.extend(new OpenLayers.LonLat(#{layer.bounding_box[:west]},#{layer.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  var boxes = new OpenLayers.Layer.Boxes('boxes');
  var box = new OpenLayers.Marker.Box(bounds#{i});
  box.setBorder('#{box_colours(i)}', 2);  
  boxes.addMarker(box);
  map.addLayer(boxes);
  
  var bounds = new OpenLayers.Bounds();
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:east]},#{@dataset.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:west]},#{@dataset.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  map.zoomToExtent(bounds);
  
  ".html_safe    
  -%>
      <% end %>
    <% end %>
  <% else %>
  <%=
  "var bounds = new OpenLayers.Bounds();
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:east]},#{@dataset.bounding_box[:north]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
  bounds.extend(new OpenLayers.LonLat(#{@dataset.bounding_box[:west]},#{@dataset.bounding_box[:south]}).transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));  
  var boxes = new OpenLayers.Layer.Boxes('boxes');
  var box = new OpenLayers.Marker.Box(bounds);
  boxes.addMarker(box);
  map.addLayer(boxes);
  map.zoomToExtent(bounds);
  map.zoomTo(map.zoom - 1);

  ".html_safe
  %>  
  <% end %>

<% end %>
});
</script>
<div class="top-back-link">
    <a href="#" onclick="history.go(-1);return false;">Back to Search Results</a>
</div>
<div class="top-container-tab-body" >
  <div class="top-container-tab" id="add-review" style="display: none;">+ Comments</div>
  <div class="top-container-tab" id="my-collection" style="display: none;">+ My collection</div>
  <div class="top-container-tab tab-download">
    <div class="float-left">Download</div>
    <div class="float-left tab-download-arrow"></div>   
  </div>
  <div class="clear"></div>
  
<%= render 'download_format_selector' %>

</div>
<div class="clear"></div>
  
<div class="clear"></div>

<div class="left-container-tab-body">
  <div class="tab"><%= link_to 'Map', :controller => 'tools', :action => 'map', :id => @dataset.uuid %></div>
  <div class="tab"><%= link_to 'Graph', :controller => 'tools', :action => 'graph', :id => @dataset.uuid %></div>
  <div class="tab"><%= link_to 'Connect', :controller => 'community' %></div>
</div>
<div class="right-container-body">
  <div class="right-container-left-body">
    <div class="dashed-header"><h2><%= @dataset.name %></h2></div>
    <div class="clear"></div>
    <div class="slight-margin">
      <h2 class="green-dot-blue-head">Metadata</h2>
      
      <div class="float-left width-165 title">Title</div>
      <div class="float-left width-500 text"><%= @dataset.name %></div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Date</div>
      <div class="float-left width-500 text"><%= @dataset.date %></div>
      <div class="clear"></div>

    <% if @dataset.period %>
      <div class="float-left width-165 title">Extent</div>
      <div class="float-left width-500 text"><%= @dataset.period %></div>
      <div class="clear"></div>
    <% end %>
      
      <div class="float-left width-165 title">Abstract</div>
      <div class="float-left width-500 text">
        <%= @dataset.description %>
        <% if !@dataset.source.nil? %>
        <br />
        <% 
          url = ''
          if @dataset.source
            if @dataset.source.match(/http:\/\//)
              url = @dataset.source
            else
              url = "http://#{@dataset.source}"
            end
          end
        %>
        (source: <%= link_to url, url %>)
        <% end %>
      </div>
      <div class="clear"></div>
      <div class="clear height-25"></div>

    
      <div class="float-left">
    <% if @dataset.bounding_box && !@dataset.bounding_box.empty? %>
        <% bbox = @dataset.bounding_box %>
        <h2 class="green-dot-blue-head">Geographic bounding box</h2>
        <div class="float-left width-165 title">East Bound Longitude</div>
        <div class="float-left width-140 text"><%= bbox[:east] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">West Bound Longitude</div>
        <div class="float-left width-140 text"><%= bbox[:west] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">North Bound Latitude</div>
        <div class="float-left width-140 text"><%= bbox[:north] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">South Bound Latitude</div>
        <div class="float-left width-140 text"><%= bbox[:south] %></div>
        <div class="clear height-25"></div>
    <% elsif @dataset.coordinates && !@dataset.coordinates.empty? %>
        <h2 class="green-dot-blue-head">Geographic coordinates</h2>
        <div class="float-left width-165 title">Latitude</div>
        <div class="float-left width-140 text"><%= @dataset.coordinates.split(',')[0] %></div>
        <div class="clear"></div>

        <div class="float-left width-165 title">Longitude</div>
        <div class="float-left width-140 text"><%= @dataset.coordinates.split(',')[1] %></div>
        <div class="clear height-25"></div>
    <% else %>
        <h2 class="green-dot-blue-head">Geographic bounding box</h2>
        <div class="float-left width-165 title">East Bound Longitude</div>
        <div class="float-left width-140 text">7.21097</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">West Bound Longitude</div>
        <div class="float-left width-140 text">3.37087</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">North Bound Latitude</div>
        <div class="float-left width-140 text">53.46583</div>
        <div class="clear"></div>
        
        <div class="float-left width-165 title">South Bound Latitude</div>
        <div class="float-left width-140 text">50.75388</div>
        <div class="clear height-25"></div>
    <% end %>
      </div>
      <div class="float-left" style="padding-left: 5px;">
        <div id="map" style="width:370px; height:200px"></div>        
      </div>
      <div class="clear"></div>
    <% if @dataset.layers %>
      <h2 class="green-dot-blue-head">Feature Layers</h2>
      <% @dataset.layers.each_with_index do |layer, i| %>
        <% if layer.bounding_box %>
      <div class="float-left width-165 title">Layer <%= i+1 %> (<span style="color: <%= box_colours(i) %>"><%= box_colours(i) %></span>)</div>
      <div class="float-left width-500 text"><%= layer.name %>, <%= layer.period %></div>
      <div class="clear"></div>
        <% end %>
      <% end %>
    <% end  %>
      
    <% if !@dataset.author.nil? %>
      <h2 class="green-dot-blue-head">Point of contact</h2>
      
      <div class="float-left width-165 title">Individual name</div>
      <div class="float-left width-500 text"><%= @dataset.author.first_name %><%= @dataset.author.last_name %></div>
      <div class="clear"></div>

<%
=begin %>     
      <div class="float-left width-165 title">Organisation name</div>
      <div class="float-left width-500 text">Deltares/TNO Geological Survey of the Canada</div>
      <div class="clear"></div>
<%
=end %>     
      <div class="float-left width-165 title">Email</div>
      <div class="float-left width-500 text"><%= @dataset.author.email %></div>
      <div class="clear"></div>
<%
=begin %>     
      <div class="float-left width-165 title">Role</div>
      <div class="float-left width-500 text">PointOfContact</div>
      <div class="clear"></div>
<%
=end %>
    <% end %>     
      <div class="float-left width-165 title">Descriptive keywords</div>
      <div class="float-left width-500 text"><%= @dataset.properties %></div>
      <div class="clear"></div>
      
      <div class="clear height-25"></div>
      
<%
=begin %>
      
      <h2 class="green-dot-blue-head">Distribution information</h2>
      
      <div class="float-left width-165 title">Intractive Map</div>
      <div class="float-left width-500 text">http://www.dinoservice.nl/wms/dinomap/MO8MOO21?format=image/png</div>
      <div class="clear"></div>
      
      <div class="clear height-25"></div>
<%
=end %>     
      
      <h2 class="green-dot-blue-head">Identification Information</h2>
      
      <div class="float-left width-165 title">File identifier</div>
      <div class="float-left width-500 text"><%= @dataset.uuid %></div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Language</div>
      <div class="float-left width-500 text">English</div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Character set</div>
      <div class="float-left width-500 text">UTF-8</div>
      <div class="clear"></div>
<%
=begin %>     
      <div class="float-left width-165 title">Date stamp</div>
      <div class="float-left width-500 text">2009-06-26T10:07:03</div>
      <div class="clear"></div>
<% 
=end %>     
      <div class="float-left width-165 title">Metadata standard name</div>
      <div class="float-left width-500 text">ISO 19115:2003/19139</div>
      <div class="clear"></div>
      
      <div class="float-left width-165 title">Metadata standard version</div>
      <div class="float-left width-500 text">1.0</div>
      <div class="clear"></div>
      
<% if !@dataset.creative_commons_license.nil? %>
      <h2 class="green-dot-blue-head">License</h2>
      <div class="float-left width-165 title">&nbsp;</div>
      <div class="float-left width-500 text"><%= "<a href='http://creativecommons.org/licenses/#{@dataset.creative_commons_license}/3.0/'><img src='/images/#{@dataset.creative_commons_license}.png' alt='creative commons' /></a>".html_safe -%></div>
      <div class="clear"></div>
<% end %>      
      
      <div class="clear height-25"></div>      
    </div>
  </div>
  <div class="sub-content-right">
    <%= render 'shared/right_panel' %>
  </div>    

  <div class="clear"></div>
  
  <%= render 'reviews' %>
    
</div>
