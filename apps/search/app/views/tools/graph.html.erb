<style>
  .sub-content-center .chart-body {
    width: 773px;
  }
  .chart1 {
    width: 780px;
    height: 360px;
  }
  #filter-container ul {
    padding: 0px;
    margin: 0 -6px 0 20px;
  }
  #filter-container li {
    font-size: 30px;
    line-height: 18px;
  }
  .mini-loading-dialog {
    background: white url(/images/spinner.gif) center top no-repeat;
    height: 55px;
    opacity: 0.6;
  }
  .property-selector {
    margin-left: 45px;
  }
</style>
<script>
  $(document).ready(function() {
   
    var allGraphData = {};
    var sharedProperties = {};

  <% @datasets.each_with_index do |dataset,i| %>
    <%= "allGraphData['#{dataset.id}'] = {};" -%>
    <%= "allGraphData['#{dataset.id}']['colour'] = '#{css_colour(i)[:code]}';" -%>
    <%= "allGraphData['#{dataset.id}']['name'] = '#{dataset.name}';" -%>    
  <% end unless !@datasets %>


    function idFromUrl(url) { return url.match(/id=([\w-]*)/)[1]; }
    function propertyFromUrl(url) { return url.match(/properties=(.[^&]*)/)[1]; }
    function graphTypeFromUrl(url) { return window.location.hash.replace('#',''); }
    function idsFromSearch() { 
      var unescapedSearch = unescape(window.location.search);
      return unescapedSearch.match(/ids=([\w-,]*)/)[1].split(','); 
    }
    function idsFromForm() {
      var ids = []
      $('[name=dataset]:checked').each(function() { ids.push($(this).val()); });
      return ids;
    }
    
    $(document).bind('drawGraph', function() { 
      var uuids = idsFromForm();
      var type = graphTypeFromUrl()

      var graphData = [];
      var graphColours = [];
      for(var i=0; i < uuids.length; i++) {
        var uuid = uuids[i];
        if (allGraphData[uuid] && allGraphData[uuid]['data']) {
          graphData.push(allGraphData[uuid]['data']);
          graphColours.push({ color: allGraphData[uuid]['colour'], label: allGraphData[uuid]['name'] });
        }
      }      

      if (type === 'pie') {
        var graphOptions = {
          seriesDefaults: {
            // Make this a pie chart.
            renderer: jQuery.jqplot.PieRenderer,
            rendererOptions: {
              // Put data labels on the pie slices.
              // By default, labels show the percentage of the slice.
              showDataLabels: true
            }
          },
          series: graphColours,
          legend: { 
            show: true,
            placement: 'outsideGrid' 
          }
        }
      } else {
        var graphOptions = {
          series: graphColours,
          legend: { show: false }
        }
      }
        
      $('#chart1').html('');
      $('#chart1').height('auto');
      if (graphData.length > 0) {
        $.jqplot('chart1', graphData, graphOptions); 
      }
      
      var legendHeight = $('table.jqplot-table-legend').height();      
      if (legendHeight) {
        $('#chart1').height(legendHeight + 40);
      }
      
      if ($('#chart1').html() === '') {
        $('#chart1').html("<div style='padding: 20px;'><strong>We're sorry, a chart for that dataset / property combination couldn't be generated. Please try another combination.</strong></div>");
      }
      
    });
    
    function loadGraphData(uuid, property) {
      var type = arguments[2] ? arguments[2] : 'line';

      $('.datasets.' + uuid).addClass('mini-loading-dialog');
      
      $.ajax({
        url: "<%= url_for :controller => 'tools', :action => 'chart_feature', :format => 'json' %>" + '&properties=' + property + '&id=' + uuid + '&type=' + type,
        global: false,
        success: function(data) {
          var uuid = idFromUrl(this.url);
          allGraphData[uuid]['data'] = data;
          
          $('.datasets.' + uuid).removeClass('mini-loading-dialog').removeClass('ui-state-disabled');
          
          var checkbox = $('[name=datasets] .' + uuid + ' [name=dataset]');
          checkbox.attr('checked', true).removeAttr('disabled');
          checkbox.click(function() { $(document).trigger('drawGraph'); });            

          $('.property-selector.' + uuid)
            .removeAttr('disabled')
            .val(propertyFromUrl(this.url))
            .unbind()
            .change(function(event) {
              if (this.value !== '') {
                $('.datasets.' + uuid).addClass('mini-loading-dialog');
                loadGraphData(uuid, this.value, type);
              }
            }
          );

          $(document).trigger('drawGraph');
        },
        error: function() {
          var uuid = idFromUrl(this.url);
          allGraphData[uuid]['data'] = [];
          
          $('[name=datasets] .' + uuid + ' [name=dataset]').attr('checked', false);

          $('.datasets.' + uuid).removeClass('mini-loading-dialog').addClass('ui-state-disabled');
          $('.datasets.' + uuid + ' input').attr('disabled', true);
          $('.property-selector.' + uuid ).unbind().change(function(event) {           
              loadGraphData(uuid, this.value);
            }
          );

          $(document).trigger('drawGraph');
        }
      });
    }
    
    $(document).bind('loadDataForSharedPropertiesAndGraph', function() {
      property = sharedProperties.numeric[0];
      var uuids = idsFromSearch();      
      for (var i=0; i < uuids.length; i++) {
        var uuid = uuids[i];
        loadGraphData(uuid, property);
      }
    });

    if (idsFromSearch().length > 1) {
      $.ajax({
        url: "<%= (url_for :controller => 'api', :action => 'shared_properties', :ids => params[:ids], :format => 'json').html_safe %>",
        global: false,
        success: function(data) {
          if (data) {
            sharedProperties = data;
            $(document).trigger('loadDataForSharedPropertiesAndGraph');
          }
        }
      });
    } else {
      $.ajax({
        url: "<%= (url_for :controller => 'api', :action => 'feature_fields_by_type', :id => params[:ids], :format => 'json').html_safe %>",
        global: false,
        success: function(data) {
          if (data && data.numeric.length > 1) {
            loadGraphData(idsFromSearch()[0], data.numeric[0]);
          }
        }
      });
    }
    
    $('.chart-button').click(function(event) {
      event.preventDefault();

      var type = event.target.hash ? event.target.hash : event.target.children[0].hash;
      type = type.replace('#','');
      window.location.hash = type;
      
      if (type == 'pie') {
        if ($('[name=dataset]:checked').length > 1) {
          $('[name=dataset]').each(function() { $(this).attr('checked', false); });
          $('[name=dataset]:first').attr('checked', true);
        }
      }
      $('.chart-button').removeClass('tab-select');
      $('.' + type + '-chart').addClass('tab-select');
      
      var uuids = idsFromForm();
      for (var i=0; i < uuids.length; i++) {
        var uuid = uuids[i];
        var property = $('.property-selector.' + uuid).val();
        
        loadGraphData(uuid, property, type);
      }   

    });
    
    $('.' + window.location.hash.replace('#','') + '-chart').addClass('tab-select');    
    
    function uuids() {
      var ids = []
      $('[name=dataset]:checked').each(function() { ids.push($(this).val()); });
      return ids;
    }
            
    $('form[name=datasets] [name=dataset]').click(function(event) {
      $('form[name=download] [name=ids]').val(uuids().join(','));
    });
    
  });
</script>

<%= render 'tool_tab_menu' %>

<div class="sub-content-body">
  <div class="sub-content-left">
    <div class="left-tab-body">
      <div class="left-tab chart-button line-chart tab-select">
        <a href="#line">Line</a>
      </div>
      <div class="left-tab chart-button pie-chart">
        <a href="#pie">Pie</a>
      </div>
    </div>
    <div class="clear"></div>
  
    <div id="filter-container">
      <div id="filter-content">
      <%= form_for :datasets, :html => { :name => 'datasets' } do |f| %>
      <%  @datasets.each_with_index do |dataset,i| %>
        <div class="mini-loading-dialog datasets <%= "#{dataset.id}" -%>">
          <div class="float-left">
            <%= check_box_tag "dataset", dataset.id, false, :id => "dataset_#{dataset.id}" %>
          </div>
          <div class="float-left width-5">&nbsp;</div>
          <div class="float-left"><label for='<%= "dataset_#{dataset.id}" %>'><ul><li style='color: <%= "#{css_colour(i)[:code]}" %>'></li></ul></label></div>
          <div class="float-left width-5">&nbsp;</div>
          <div class="float-left width-210">
            <label for='<%= "dataset_#{dataset.id}" %>'>
              <div class="tool-left-link">
              <%= link_to "#{dataset.name}", {:controller => 'catalogue', :action => 'details', :id => dataset.id}, :target => 'blank' %>
              </div>
              <div class="tool-left-text">
              <%= more_markup(dataset.description).html_safe -%>
              </div>
            </label>
          </div>
        </div>
        <select class="select-box-2 property-selector <%= "#{dataset.id}" %>">
          <option></option>
          <% dataset.properties.split(',').each do |prop| %>
          <% if !prop.match(/latitude|longitude/i) %>
          <%= "<option>#{prop}</option>".html_safe -%>
          <% end %>
          <% end %>
        </select>        
        <div class="clear height-5">&nbsp;</div>
      <% end unless !@datasets %>
      <% end %>
            
      </div>
    </div>
  </div>
  <div class="sub-content-center">
    <div class="chart-body">
      <div id="chart1"></div>
    </div>    
  </div>
<%
=begin %>  
  <div class="sub-content-right">
    <%= render 'shared/right_panel' %>    
  </div>
<%
=end %>  
  <div class="clear"></div>
</div>
